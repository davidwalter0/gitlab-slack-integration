#!/bin/bash

function timestamp
{
    echo $(export TZ=US/Eastern; date +%Y.%m.%d.%H.%M.%S.%:::z )
}

function usage
{
    echo ${0##*/} --repo-list=repo-file-list --gitlab-user=username

    echo ${0} requires a repository file with space separated
    echo       repository urls and push-to user[gitlab-user] 
    echo The pull from host and user are embedded in the repo list urls.

    exit 3
}

function monitor
{
    local gitlab=128.107.15.214     # k8s-node-02
    # local github_user=davidwalter0
    local gitlab_user=build.bot.0
    local github=github.com

    for arg in ${@}; do
        case ${arg} in
            --repo-list=*)
                repo_list=${arg##*=}
                ;;
            # --github-user=*)
            #     github_user=${arg##*=}
            #     ;;
            --gitlab-user=*)
                gitlab_user=${arg##*=}
                ;;
            # --repo-list*|--gitlab-user*|--github-user*)
            --repo-list*|--gitlab-user*)
                usage
                ;;
            *)
                usage
        esac
    done

    if ! mkdir -p /var/lib/mirror; then
        printf "Failed to create /var/lib/mirror, are you running with the correct permissions?\n\n"
        usage
    fi

    while : ; do
        echo $(timestamp) start new poll run
        for fullrepo in $(cat ${repo_list}); do
            echo $(timestamp) checking repo ${fullrepo}

            repo="${fullrepo##*/}"
            name="${repo##*/}"
            name="${repo%.git}"
                    
            cd /var/lib/mirror

            gitlabrepo=git@${gitlab}:${gitlab_user}/${repo}
            if [[ ! -e ${name} ]]; then
                git clone ${fullrepo}
                cd /var/lib/mirror/${name}
                git config push.default simple
                git remote add gitlab ${gitlabrepo}
            else
                cd /var/lib/mirror/${name}
            fi

            if git checkout master &>/dev/null ; then
                if git pull github master; then
                    echo $(timestamp) pushing repo ${gitlabrepo} master
                    git push gitlab master
                fi
            fi
            if git checkout k8s-cfg &>/dev/null ; then
                if git pull github k8s-cfg; then
                    echo $(timestamp) pushing repo ${gitlabrepo} k8s-cfg
                    git push gitlab k8s-cfg
                fi
            fi
        done
        echo $(timestamp) end poll run
        sleep 60
    done
}

monitor ${@}
