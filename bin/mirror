#!/bin/bash

function usage
{
    echo ${0##*/} --repos=repo-file-list
    echo ${0} requires a repository file with space separated repository names
    exit 3
}

for arg in ${@}; do
    case ${arg} in
    --repos=*)
        repos=${arg##*=}
        ;;
    --repos)
        usage
        ;;
    *)
        echo ${0##*/} --repos=repos-file-list
        echo ${0} requires repository list argument
        exit 3
    esac
done

function monitor
{
    if [[ ! ${repos:-} || ! -e ${repos} ]]; then
        usage
    fi
    local gitlab=k8s-node-02
    local user=davidwalter0
    local github=github.com
    mkdir -p /var/lib/mirror
    while : ; do
        echo start new poll run $(date +%Y.%m.%d.%H.%M.%S.%::z)
        for fullrepo in $(cat ${repos}); do
            repo="${fullrepo##*/}"
            name="${repo##*/}"
            name="${repo%.git}"
            gitlabrepo=git@${gitlab}:${user}/${repo}

            cd /var/lib/mirror

            if [[ ! -e ${name} ]]; then
                git clone ${fullrepo}
                cd /var/lib/mirror/${name}
                git config push.default simple
                git remote add github ${fullrepo}
                git remote add gitlab ${gitlabrepo}
            else
                cd /var/lib/mirror/${name}
            fi

            if git checkout master &>/dev/null ; then
                if git pull github master; then
                    git push gitlab master
                fi
            fi
            if git checkout k8s-cfg &>/dev/null ; then
                if git pull github k8s-cfg; then
                    git push gitlab k8s-cfg
                fi
            fi
            if [[ ! -e .slackurl ]]; then
               curl --silent --output=/tmp/${name}-slack-url http://config/slackurl
            else
               cp .slackurl /tmp/${name}-slack-url
            fi
        done
        echo end poll run $(date +%Y.%m.%d.%H.%M.%S.%::z)
        sleep 60
    done
}

monitor
