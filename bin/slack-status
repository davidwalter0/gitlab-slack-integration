#!/bin/bash
debug=0

dir=$(dirname $(readlink -f ${0}))
short=${dir%/*}
short=${short##*/}
gitlabhost=k8s-node-02
gitlabhost=128.107.15.214
user=davidwalter0
# make the json file one per call.
json=$(mktemp)
slackconfig=http://slack-config/slackurl
slackurl=$(mktemp /tmp/slack-url.XXXX)

function usage
{
    echo ${0##*/} step-or-current-process-name return-code
    exit 3
}

step=${1}

if [[ ! ${step:-} ]]; then
    usage
fi

status=0

if (( ${#} < 2 )); then
    usage
else
    status=${2}
fi

case ${status} in
    0)
        status=success
        ;;
    1)
        status=warning
        ;;
    2)
        status=error
        ;;
    3)
        status="process or sequence error"
        ;;
esac

if (( debug )) ; then
    ssh k8s-node-02 curl --silent http://slack-config/slackurl > ${slackurl}
else
    curl --silent --output ${slackurl} ${slackconfig}
fi
echo slackurl=${slackurl}
chmod 600 ${slackurl}
if [[ -e ${slackurl} ]]; then
    for url in $(cat ${slackurl}); do
        yaml2json --compress > ${json} <<EOF
attachments:                                                                                                        
- color: "#D00000"
  user: GitlabWebhook
  fallback: |
     <http://${gitlabhost}/${user}/${short}/builds|${short} step: ${step} status: ${status}>
  fields:                                                                                   
    - short: false                  
      # title: "<http://${gitlabhost}/${user}/builds|${short} step: ${step} status: ${status}>"
      value: |
        <http://${gitlabhost}/${user}/${short}/builds|${short} step: ${step} status: ${status}>
  # pretext: |
  #   <http://${gitlabhost}/${user}/${short}/builds|${short} step: ${step} status: ${status}>
EOF
        #curl --silent $(cat ${slackurl}) -d@"${json}"
        curl --silent ${url} -d@"${json}"
    done
fi
rm -f ${json} ${slackurl}
